<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Tareas – Equipo</title>
  <meta name="theme-color" content="#3b82f6" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #f5f7fa;
      --primary: #3b82f6;
      --danger: #ef4444;
      --success: #22c55e;
      --text: #111827;
      --font: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0 }
    body { font-family: var(--font); background: var(--bg); color: var(--text) }
    header { display: flex; justify-content: space-between; align-items: center; gap: .5rem; padding: 1rem 1.2rem; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.06); flex-wrap: wrap }
    header h1 { font-size: 1.25rem }
    button { cursor: pointer; border: none; border-radius: .375rem; padding: .5rem .75rem; font-size: .875rem }
    #addTaskBtn { background: var(--primary); color: #fff }
    #logoutBtn { background: var(--danger); color: #fff; margin-left: .5rem }

    /* ===== FILTROS ===== */
    #extraFilters { display: flex; gap: .5rem; flex-wrap: wrap; margin: .5rem 1rem }
    #extraFilters select { padding: .4rem .5rem; border: 1px solid #d1d5db; border-radius: .375rem }

    #kanban { display: flex; gap: 1rem; padding: 1rem; overflow-x: auto }
    .column { flex: 1 1 260px; background: #fff; border: 1px solid #e5e7eb; border-radius: .5rem }
    .column[data-status="todo"] h3 { background: #ef4444; color: #fff; margin: 0 }
    .column[data-status="doing"] h3 { background: #3b82f6; color: #fff; margin: 0 }
    .column[data-status="done"] h3 { background: #22c55e; color: #fff; margin: 0 }
    .column h3 { padding: .75rem 1rem; border-bottom: 1px solid #e5e7eb; font-size: 1rem }
    .column ul { list-style: none; padding: .5rem; min-height: 200px }
    .task-card { background: #fff; border: 1px solid #d1d5db; border-radius: .375rem; padding: .5rem .75rem; margin-bottom: .5rem; cursor: grab }
    .task-card .title { font-weight: 600; font-size: .9rem }
    .task-card .meta { font-size: .7rem; color: #6b7280 }
    .task-card .actions { display: flex; gap: .25rem; margin-top: .25rem }
    .btn-del, .btn-edit { background: #ef4444; color: #fff; font-size: .7rem; padding: .2rem .4rem; margin-right: .2rem }

    /* ===== SUB-TAREAS ===== */
    .subtask { font-size: .7rem; border-top: 1px solid #e5e7eb; margin-top: .25rem; padding-top: .25rem }
    .subtask span { display: block }
    .addSubBtn { font-size: .65rem; background: var(--primary); color: #fff; margin-top: .25rem }

    dialog { border: none; border-radius: .5rem; max-width: 480px; width: 90% }
    dialog::backdrop { background: rgba(0,0,0,.5) }
    dialog h2 { margin-bottom: 1rem }
    dialog label { display: block; margin: .5rem 0 .25rem; font-size: .875rem }
    dialog input, dialog select, dialog textarea { width: 100%; padding: .4rem .5rem; border: 1px solid #d1d5db; border-radius: .375rem; font-size: .875rem }
    dialog textarea { resize: vertical; min-height: 60px }
    #loginForm { display: flex; flex-direction: column; gap: .75rem; max-width: 320px; margin: 20vh auto; padding: 2rem; background: #fff; border-radius: .5rem; box-shadow: 0 4px 12px rgba(0,0,0,.1) }

    /* ===== AUTOCOMPLETE ===== */
    .datalist { position: relative }
    .datalist datalist { max-height: 120px; overflow-y: auto }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginSection">
    <form id="loginForm">
      <h2>Iniciar sesión</h2>
      <label>E-mail
        <input type="email" id="userEmail" required placeholder="admin@demo.com" />
      </label>
      <label>Contraseña
        <input type="password" id="userPass" required placeholder="admin123" />
      </label>
      <button type="submit">Entrar</button>
    </form>
  </div>

  <!-- APP -->
  <div id="appSection" style="display:none">
    <header>
      <h1>Gestor de Tareas</h1>
      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
        <input type="date" id="fromDate" title="Desde">
        <input type="date" id="toDate" title="Hasta">
        <button id="filterBtn">Filtrar</button>
        <button onclick="printTasks()">Imprimir</button>
        <button onclick="exportExcel()">Excel</button>
        <button onclick="exportPDF()">PDF</button>
        <button id="addTaskBtn">+ Nueva&nbsp;Tarea</button>
        <button id="logoutBtn">Salir</button>
      </div>
    </header>

    <!-- FILTROS EXTRA -->
    <div id="extraFilters">
      <select id="filterCategory">
        <option value="">Todas las categorías</option>
      </select>
      <select id="filterPriority">
        <option value="">Todas las prioridades</option>
        <option>Alta</option>
        <option>Media</option>
        <option>Baja</option>
      </select>
      <select id="filterAssigned">
        <option value="">Todos los asignados</option>
      </select>
    </div>

    <div id="kanban">
      <div class="column" data-status="todo">
        <h3>Por hacer</h3>
        <ul ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
      </div>
      <div class="column" data-status="doing">
        <h3>En proceso</h3>
        <ul ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
      </div>
      <div class="column" data-status="done">
        <h3>Finalizada</h3>
        <ul ondrop="drop(event)" ondragover="allowDrop(event)"></ul>
      </div>
    </div>

    <dialog id="taskDialog">
      <form id="taskForm">
        <h2 id="dialogTitle">Nueva tarea</h2>
        <input type="hidden" id="taskId">
        <label>Título <input type="text" id="title" name="title" required></label>
        <label>Descripción <textarea id="desc" name="desc"></textarea></label>

        <!-- AUTOCOMPLETADO -->
        <label class="datalist">
          Asignado a
          <input type="email" id="assigned" name="assigned" required list="assignedList"
            placeholder="correo@ejemplo.com">
          <datalist id="assignedList"></datalist>
        </label>

        <label class="datalist">
          Categoría
          <input type="text" id="category" name="category" list="categoryList">
          <datalist id="categoryList"></datalist>
        </label>

        <label>Prioridad
          <select id="priority" name="priority">
            <option>Alta</option>
            <option selected>Media</option>
            <option>Baja</option>
          </select>
        </label>
        <label>Fecha límite <input type="date" id="due" name="due"></label>
        <label>Estado
          <select id="status" name="status">
            <option value="todo">Por hacer</option>
            <option value="doing">En proceso</option>
            <option value="done">Finalizada</option>
          </select>
        </label>

        <!-- SUB-TAREAS -->
        <label>Sub-tareas (una por línea: descripción | fecha)
          <textarea id="subtasksInput" placeholder="Ej: Revisar diseño | 2025-08-30"></textarea>
        </label>

        <div>
          <button type="submit">Guardar</button>
          <button type="button" id="cancelBtn">Cancelar</button>
        </div>
      </form>
    </dialog>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const ADMIN = { email: 'admin@demo.com', pass: 'admin123' };
    const USERS = [ADMIN, { email: 'ana@demo.com', pass: 'ana123' }, { email: 'luis@demo.com', pass: 'luis123' }];
    const STORAGE_TASKS = 'gt_tasks_v7';
    const STORAGE_USER = 'gt_user_v7';

    let USER = JSON.parse(localStorage.getItem(STORAGE_USER) || 'null');
    let allTasks = [];
    let filteredTasks = [];

    /* ===== LOGIN ===== */
    const loginSection = document.getElementById('loginSection');
    const appSection = document.getElementById('appSection');
    const loginForm = document.getElementById('loginForm');
    const userEmailInp = document.getElementById('userEmail');
    const userPassInp = document.getElementById('userPass');
    const logoutBtn = document.getElementById('logoutBtn');

    function checkAuth() {
      if (USER) {
        loginSection.style.display = 'none';
        appSection.style.display = 'block';
        initApp();
      } else {
        loginSection.style.display = 'flex';
        appSection.style.display = 'none';
      }
    }

    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const email = userEmailInp.value.trim().toLowerCase();
      const pass = userPassInp.value;
      const found = USERS.find(u => u.email === email && u.pass === pass);
      if (!found) return alert('Credenciales incorrectas');
      USER = { email: found.email, isAdmin: found.email === ADMIN.email };
      localStorage.setItem(STORAGE_USER, JSON.stringify(USER));
      checkAuth();
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem(STORAGE_USER);
      USER = null;
      checkAuth();
    });

    /* ===== TASKS ===== */
    function loadTasks() {
      allTasks = JSON.parse(localStorage.getItem(STORAGE_TASKS) || '[]');
    }

    function saveTasks() {
      localStorage.setItem(STORAGE_TASKS, JSON.stringify(allTasks));
    }

    /* ===== AUTOCOMPLETE DATA ===== */
    const assignedList = document.getElementById('assignedList');
    const categoryList = document.getElementById('categoryList');
    const filterCategorySel = document.getElementById('filterCategory');
    const filterAssignedSel = document.getElementById('filterAssigned');

    function populateDatalists() {
      const allEmails = [...new Set(allTasks.map(t => t.assigned).concat(USERS.map(u => u.email)))];
      const allCategories = [...new Set(allTasks.map(t => t.category).filter(Boolean))];

      assignedList.innerHTML = '';
      allEmails.forEach(e => {
        const o = document.createElement('option');
        o.value = e;
        assignedList.appendChild(o);
      });

      categoryList.innerHTML = '';
      allCategories.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        categoryList.appendChild(o);
      });

      /* Rellena filtros */
      filterCategorySel.innerHTML = '<option value="">Todas las categorías</option>';
      allCategories.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        filterCategorySel.appendChild(o);
      });

      filterAssignedSel.innerHTML = '<option value="">Todos los asignados</option>';
      allEmails.forEach(e => {
        const o = document.createElement('option');
        o.value = e;
        o.textContent = e;
        filterAssignedSel.appendChild(o);
      });
    }

    /* ===== FILTER ===== */
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const filterBtn = document.getElementById('filterBtn');

    function filterTasks() {
      const from = fromDate.value ? new Date(fromDate.value) : null;
      const to = toDate.value ? new Date(toDate.value) : null;
      const cat = filterCategorySel.value;
      const pri = document.getElementById('filterPriority').value;
      const ass = filterAssignedSel.value;

      let list = USER.isAdmin ? allTasks : allTasks.filter(t => t.assigned === USER.email);
      if (from) list = list.filter(t => new Date(t.createdAt) >= from);
      if (to) list = list.filter(t => new Date(t.createdAt) <= to);
      if (cat) list = list.filter(t => t.category === cat);
      if (pri) list = list.filter(t => t.priority === pri);
      if (ass) list = list.filter(t => t.assigned === ass);

      filteredTasks = list;
      renderTasks();
    }

    /* ===== RENDER ===== */
    const kanban = document.getElementById('kanban');
    const addBtn = document.getElementById('addTaskBtn');
    const dlg = document.getElementById('taskDialog');
    const form = document.getElementById('taskForm');
    const cancel = document.getElementById('cancelBtn');

    function renderTasks() {
      kanban.querySelectorAll('.column ul').forEach(ul => ul.innerHTML = '');
      filteredTasks.forEach(t => {
        const li = document.createElement('li');
        li.className = 'task-card';
        li.draggable = true;
        li.dataset.id = t.id;
        li.ondragstart = e => e.dataTransfer.setData('text/plain', t.id);

        let subHTML = '';
        if (t.subtasks && t.subtasks.length) {
          subHTML = '<div class="subtask">';
          t.subtasks.forEach(s => {
            subHTML += `<span>• ${s.desc} (vence: ${s.due || '—'})</span>`;
          });
          subHTML += '</div>';
        }

        li.innerHTML = `
          <div class="title">${t.title}</div>
          <div class="meta">${t.category || '—'} | ${t.priority} | Vence: ${t.due || '—'}</div>
          ${subHTML}
          <div class="actions">
            <button class="btn-edit" onclick="editTask('${t.id}')">Editar</button>
            ${USER.isAdmin || t.assigned === USER.email
              ? `<button class="btn-del" onclick="delTask('${t.id}')">Eliminar</button>`
              : ''}
          </div>
        `;
        kanban.querySelector(`.column[data-status="${t.status}"] ul`).appendChild(li);
      });
    }

    /* ===== DRAG & DROP ===== */
    function allowDrop(ev) { ev.preventDefault(); }

    function drop(ev) {
      ev.preventDefault();
      const taskId = ev.dataTransfer.getData('text/plain');
      const targetCol = ev.currentTarget.closest('.column').dataset.status;
      const task = allTasks.find(t => t.id === taskId);
      if (task) {
        task.status = targetCol;
        saveTasks();
        filterTasks();
      }
    }

    /* ===== CRUD ===== */
    function editTask(id) {
      const t = allTasks.find(t => t.id === id);
      if (!t) return;
      Object.keys(t).forEach(k => {
        if (form.elements[k]) form.elements[k].value = t[k];
      });
      form.taskId.value = t.id;
      dialogTitle.textContent = 'Editar tarea';
      dlg.showModal();
    }

    function delTask(id) {
      if (!confirm('¿Eliminar esta tarea?')) return;
      allTasks = allTasks.filter(t => t.id !== id);
      saveTasks();
      filterTasks();
    }

    /* ===== EXPORT ===== */
    function printTasks() {
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>Tareas</title></head><body>
        <h1>Tareas (${USER.isAdmin ? 'Todas' : USER.email})</h1>
        <table border="1" cellspacing="0" cellpadding="4">
          <thead><tr>
            <th>Título</th><th>Descripción</th><th>Asignado</th><th>Categoría</th>
            <th>Prioridad</th><th>Vence</th><th>Estado</th>
          </tr></thead>
          <tbody>
            ${filteredTasks.map(t => `
              <tr>
                <td>${t.title}</td><td>${t.desc}</td><td>${t.assigned}</td>
                <td>${t.category}</td><td>${t.priority}</td><td>${t.due || ''}</td>
                <td>${t.status}</td>
              </tr>`).join('')}
          </tbody>
        </table>
        </body></html>`);
      w.document.close();
      w.print();
    }

    function exportExcel() {
      const ws = XLSX.utils.json_to_sheet(filteredTasks.map(t => ({
        Título: t.title,
        Descripción: t.desc,
        Asignado: t.assigned,
        Categoría: t.category,
        Prioridad: t.priority,
        Vence: t.due || '',
        Estado: t.status
      })));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Tareas');
      XLSX.writeFile(wb, 'tareas.xlsx');
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('Listado de Tareas', 14, 20);
      let y = 30;
      filteredTasks.forEach(t => {
        doc.setFontSize(10);
        doc.text(`${t.title} | ${t.assigned} | ${t.status}`, 14, y);
        y += 6;
        if (y > 280) { doc.addPage(); y = 20; }
      });
      doc.save('tareas.pdf');
    }

    /* ===== FORM / DIALOG ===== */
    addBtn.addEventListener('click', () => {
      form.reset();
      form.taskId.value = '';
      dialogTitle.textContent = 'Nueva tarea';
      dlg.showModal();
    });

    cancel.addEventListener('click', () => dlg.close());

    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      if (!data.assigned.trim()) { alert('Debes indicar un correo en “Asignado a”'); return; }

      /* Parsear sub-tareas */
      const subLines = document.getElementById('subtasksInput').value.trim().split('\n').filter(Boolean);
      const subtasks = subLines.map(l => {
        const [desc, due] = l.split('|').map(s => s.trim());
        return { desc, due: due || null };
      });

      if (data.taskId) {
        const idx = allTasks.findIndex(t => t.id === data.taskId);
        allTasks[idx] = { ...allTasks[idx], ...data, subtasks };
      } else {
        allTasks.push({
          ...data,
          id: crypto.randomUUID(),
          createdAt: new Date().toISOString(),
          subtasks
        });
      }
      saveTasks();
      populateDatalists();
      filterTasks();
      dlg.close();
    });

    /* ===== INIT ===== */
    function initApp() {
      loadTasks();
      populateDatalists();
      filterTasks();
      filterBtn.addEventListener('click', filterTasks);
      document.getElementById('filterCategory').addEventListener('change', filterTasks);
      document.getElementById('filterPriority').addEventListener('change', filterTasks);
      document.getElementById('filterAssigned').addEventListener('change', filterTasks);
    }

    checkAuth();
  </script>
</body>

</html>